
# Data from the ATpolyDB on easyGWAS

# Following readME:

# Step 1: Convert genotype data and generate a raw phenotype file for Biglasso using PLINK

plink --file genotype --recodeA --out p1

# generates output p1.raw

# Step 2: Integrate raw phenotype data into genotype data to be compatible with Biglasso
# created a conda environment with the necessary packages

conda create -c conda-forge -n python_pandas_matplotlib_seaborn_env python pandas matplotlib seaborn
conda activate python_pandas_matplotlib_seaborn_env

# ran script

python3 get_input_with_Emco5.py

# generates re_p1_Emco5.raw

# Step 3: Use Biglasso in R to identify the top 20 SNPs

install.packages("Matrix")
install.packages("ncvreg")
library(ncvreg)
library(Matrix)
install.packages("biglasso")
library(biglasso)
install.packages("bigmemory")
library(bigmemory)
install.packages("readr")
library(readr)

# Set working directory

# Define the phenotype variable
phenotype <- "Emco5"

# Remove existing files
file.remove(paste0("re_p1_", phenotype, ".bin"))
file.remove(paste0("re_p1_", phenotype, ".desc"))

# Set up and load the big data matrix
X <- setupX(filename = paste0("re_p1_", phenotype, ".raw"), sep=',')
X <- attach.big.matrix(paste0("re_p1_", phenotype, ".desc"))

# Extract independent and dependent variables
y <- X[,1]
X <- X[,-1]
X.bm <- as.big.matrix(X)

# Check Datastructure
str(X.bm)
print(dim(X.bm))
print(X.bm[1:10, 1:10])
print(table(y))

# Run BigLasso
fit <- biglasso(X.bm, y, ncores = 4)
fit <- biglasso(X.bm, y, family = "binomial", ncores = 4)
fit
# Emco5:      lambda = 0.06   Anthocyanin_22: lambda = 0.125
# FT10:       lambda = 0.14   Width_22:       lambda = 0.135
# Silique_16: lambda = 0.14   Silique_22:     lambda = 0.14
# Germ_22:    lambda = 0.01
coefs <- as.matrix(coef(fit, lambda = 0.06))
non_zero_coefs <- coefs[coefs != 0, ]

# Sorted non-zero coefficients
sorted_coefs <- non_zero_coefs[order(abs(non_zero_coefs), decreasing = TRUE)]
print(sorted_coefs)
print(predict(fit, lambda = 0.06, type = "nvars"))

# Write sorted non-zero coefficients
write.table(sorted_coefs, file = paste0("out_", phenotype, ".txt"), sep = "\t", col.names = NA, quote = FALSE)

# generates output out_Emco5.txt

# Step 4: Compare SNPs identified with Biglasso to those identified with PLINK

# First run PLINK association analysis to identify SNPs
# To create a file with phenotype information for Emco5 compatible with PLINK:

cut -d ' ' -f1,2,3 phenotypes.pheno > phenotypes.txt
awk '{gsub(/nan/, "-9", $3)}1' phenotypes.txt > phenotypes_edited.txt
awk '{gsub(/1.0/, "2", $3)}1' phenotypes_edited.txt > phenotypes_edited_case.txt
awk '{gsub(/0.0/, "1", $3)}1' phenotypes_edited_case.txt > phenotypes_edited_cc.txt

# using the adjust flag computes a few different multiple test corrections
plink --file genotype --pheno phenotypes_edited_cc.txt --assoc --maf 0.05 --adjust --allow-no-sex --out genotypes_assoc

# outputting the top 20 SNPs (lowest p-values)

sort -k9g genotypes_assoc.assoc.adjusted > sorted_adjusted.txt
head -n20 sorted_adjusted.txt > plink_Emco5_top_20_snps.txt

# Now run python script and install required packages

conda install openpyxl
python3 get_snp_rank.py

# ouputs excel file of SNPs and how their ranking compares between Biglasso and plink
